import numpy as np
from generate_data import RK4
import matplotlib.pyplot as plt
from run_da import path_to_specs, read_specs
import argparse
import os

plt.style.use('seaborn')

######### May need to change to match your files #################
def get_data(data_folder, name):
    results = np.load(data_folder + name +'_results.npz', allow_pickle = True)
    if twin: true_data = np.load(data_folder + 'all_' + name + '.npy')
    obs_data = np.load(data_folder + name + '.npy')

    # make images folder if does not exist
    folder_name = data_folder + name + '_images'
    if not os.path.exists(folder_name):
        os.makedirs(folder_name)
    return results, true_data, obs_data
##################################################################

def get_args():
    parser = argparse.ArgumentParser()
    parser.add_argument('-np', '--num_pred',
                         type = int,
                         help = '<Optional> num time steps to predict forward')
    parser.add_argument('-t', '--twin',
                         help = '<Optional> was data generated by generate_data.py. If so plot true data',
                         action="store_true")
    parser.add_argument('-vars', '--vars_to_plot',
                        nargs = '+',
                        help = '<Optional> List of vars to plot, default plot all. ex: -vars 0 3 4 5',
                        type = int)
    args = parser.parse_args()
    return args

def plot_action(action):
    fig1 = plt.figure(figsize = (10, 7))
    min_action = (0, np.inf)
    for i, a in enumerate(action):
        if a[-1] < min_action[1]: min_action = (i, a[-1])
        plt.plot(np.log(a), lw = 3)
    print('min action is {:1.3f} with id {:d}'.format(min_action[1], min_action[0]))
    print('param estimates', params[min_action[0]])
    plt.title('Action Levels ' + name, fontsize = 22)
    plt.ylabel('Log Action', fontsize = 16)
    plt.xlabel('beta', fontsize = 16)
    fig1.savefig(folder_name +'/' + name + '_action_levels.pdf', bbox_inches = 'tight')

if __name__ == '__main__':
    args = get_args()
    specs = read_specs(path_to_specs)

    data_folder = specs['data_folder']
    name = specs['name']

    obs_vars = specs['obs_dim'] if specs['obs_dim'] != -1 else np.arange(specs['num_dims'])
    twin = args.twin # was data generated by generate_data.py
    vars_to_plot = np.array(args.vars_to_plot) if args.vars_to_plot is not None else np.arange(specs['num_dims'])
    num_pred = args.num_pred # number of time steps to predict forward

    results, true_data, obs_data = get_data(data_folder, name)

    if specs.get('stim_file') is not None:
        stim = np.load(data_folder + specs['stim_file'])[:, 1]
    else: stim = None

    paths = results['path']
    params = results['params']
    action = results['action']
    
    # fig 1 action plot
    plot_action(action)

    # fig 2 estimation and prediction for obs variables
    estimation = paths[min_action[0]].reshape(results['num_data'], results['num_dims'])

    set_vtp = set(vars_to_plot)
    set_ov = set(obs_vars)

    obs_plots = list(set_vtp.intersection(set_ov)).sort()
    unobs_plots = list(set_vtp.difference(set_ov)).sort()

    fig_obs, ax_obs = plt.subplots(len(obs_plots), 1)
    for i, ax in enumerate(ax_obs):
        ax.plot()







